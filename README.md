# üìû –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π —Å–µ—Ä–≤–∏—Å –≤—ã–∑–æ–≤–æ–≤ –ø–æ actionURL

FastAPI-—Å–µ—Ä–≤–∏—Å –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–≥–æ –≤–µ–±-–ø–æ—Ä—Ç–∞–ª–∞ —Å IP-—Ç–µ–ª–µ—Ñ–æ–Ω–∏–µ–π –Ω–∞ –±–∞–∑–µ –ü—Ä–æ—Ç–µ–π. –ü–æ–∑–≤–æ–ª—è–µ—Ç –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å –≤—ã–∑–æ–≤—ã –Ω–∞ —Ä–∞–±–æ—á–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –ø–æ –Ω–∞–∂–∞—Ç–∏—é –∫–Ω–æ–ø–∫–∏ –Ω–∞ –ø–æ—Ä—Ç–∞–ª–µ (actionURL).   
–î–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–Ω–µ—à–Ω–∏–π –±—ç–∫–µ–Ω–¥ —Å SSO –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π —á–µ—Ä–µ–∑ AD, —á—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.

---

## üöÄ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

* –û–±—Ä–∞–±–æ—Ç–∫–∞ URL-–∑–∞–ø—Ä–æ—Å–æ–≤ —Å –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–≥–æ –ø–æ—Ä—Ç–∞–ª–∞
* –ì–µ–Ω–µ—Ä–∞—Ü–∏—è actionURL-–∑–∞–ø—Ä–æ—Å–æ–≤ –∫ —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã–º –∞–ø–ø–∞—Ä–∞—Ç–∞–º (–¢–ê)
* –ü–µ—Ä–µ–±–æ—Ä –ø–∞—Ä–æ–ª–µ–π –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –¢–ê —Ñ–∏–ª–∏–∞–ª–æ–≤
* –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π –∏ –æ—à–∏–±–æ–∫
* –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–æ—Å—Ç—É–ø–∞ –ø–æ IP-–∞–¥—Ä–µ—Å–∞–º
* –°–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤
* –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π –≤ —Ç–∞–±–ª–∏—Ü–µ –ø–æ –Ω–æ–º–µ—Ä—É

---
## üì¶ API –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã

### `POST /call`

–ò–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å –∑–≤–æ–Ω–æ–∫ –º–µ–∂–¥—É –¥–≤—É–º—è –∞–±–æ–Ω–µ–Ω—Ç–∞–º–∏

**Payload:**

```json
{
  "caller": 101,
  "name_caller": "–ò–≤–∞–Ω–æ–≤ –ò.–ò.",
  "called": 202
}
```

**Response:**

```json
{
  "result": "–í—ã–∑–æ–≤ –∑–∞–ø—É—â–µ–Ω"
}
```

---

### `POST /phones`

–°–æ–∑–¥–∞—Ç—å –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ (–æ–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ)

**Payload:**

```json
[
  {
    "phone_number": 101,
    "user_name": "–ò–≤–∞–Ω–æ–≤ –ò.–ò."
  },
  {
    "phone_number": 102,
    "user_name": "–ü–µ—Ç—Ä–æ–≤ –ü.–ü."
  }
]
```

---

### `PATCH /phones`

–û–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞

**Payload:**

```json
{
  "phone_number": 101,
  "user_name": "–ù–æ–≤–æ–µ –∏–º—è"
}
```

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

* **IP-—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è**: —Ä–∞–∑—Ä–µ—à–µ–Ω—ã —Ç–æ–ª—å–∫–æ IP-–∞–¥—Ä–µ—Å–∞, —É–∫–∞–∑–∞–Ω–Ω—ã–µ –≤ `settings.ip_service` –∏ `settings.ip_mkd`
* **–ë–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏**: –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ IP, –±–µ–∑ —Ç–æ–∫–µ–Ω–æ–≤ –∏ –ª–æ–≥–∏–Ω–æ–≤

---

## üõ† –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

* **FastAPI** ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π backend-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫
* **Uvicorn** ‚Äî ASGI-—Å–µ—Ä–≤–µ—Ä
* **Pydantic** ‚Äî –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
* **logging** ‚Äî –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ —Å—Ç–∞—Ç—É—Å–∞

---

## ‚öôÔ∏è –ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞

```http
POST /call
Authorization: Bearer <your_token>

{
  "extension": "101",
  "target_number": "+79001234567"
}
```



### –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:  
1. –í –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏: `/home/conference/api_for_call` –≤—ã–ø–æ–ª–Ω–∏—Ç—å:  `. venv/bin/activate`  
2. –í –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏: `/home/conference/api_for_call/app` –≤—ã–ø–æ–ª–Ω–∏—Ç—å: `uvicorn app.main:app --reload --host 10.7.83.208 --port 9000`  

–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ë–î –Ω–æ–º–µ—Ä–æ–≤ –≤—ã–ø–æ–ª–Ω—è—Ç—å –Ω–∞ –ê–¢–°:  
1. –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å —Å–∫—Ä–∏–ø—Ç–æ–º  
cp /home/protei/Protei-PPS/Server/data/data.sqlite /home/support/database_for_api/phones.sqlite  
2. –û—Ç–ø—Ä–∞–≤–∫–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä:  
python3 sqlite_drivers.py  
–∏–ª–∏
python3 sqlite_drivers_bulk.py

–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ IP –∞–¥—Ä–µ—Å–∞ –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤:
1. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª –±–∞–∑—ã –ú–ö–î
cp /home/protei/Protei-MKD/MKD/profiles/registrations.db /home/support/database_for_api/reg_from_mkd.json
–í—ã–ø–æ–ª–Ω–∏—Ç—å python3 json_parser.py 

–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Ñ–∏–ª–∏–∞–ª–æ–≤ –≤ API(–∑–∞–≥—Ä—É–∑–∫–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö):  
–í—ã–ø–æ–ª–Ω—è—Ç—å –ø–µ—Ä–≤—ã–π —Ä–∞–∑:  
0. –í—Å–µ –ø–æ–¥ sudo su;  
1. –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é /home/support/data_for_api: mkdir data_for_api  
–í—ã–ø–æ–ª–Ω—è—Ç—å –∫–æ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –Ω–æ–≤—ã–µ –∞–±–æ–Ω–µ–º–µ–Ω—Ç—ã:  
2. –ö–æ–ø–∏—Ä—É–µ–º –ë–î —Å –ü–ü–°: cp /home/protei/Protei-PPS/Server/data/data.sqlite /home/support/data_for_api/phones.sqlite 
3. –ö–æ–ø–∏—Ä—É–µ–º json —Å –ú–ö–î —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ IP-–∞–¥—Ä–µ—Å–∞–º–∏: cp /home/protei/Protei-MKD/MKD/profiles/registrations.db /home/support/data_for_api/reg_from_mkd.json  
4. –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç –ø–æ –∑–∞–≥—Ä—É–∑–∫–µ –∞–±–æ–Ω–µ–Ω—Ç–æ–≤ —Å –ë–î –ü–ü–° –∏ –ú–ö–î: python3 sqlite_driver.py   
–í—ã–ø–æ–ª–Ω—è–µ–º –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è IP –∞–¥—Ä–µ—Å–æ–≤ –Ω–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ:  
3. –ö–æ–ø–∏—Ä—É–µ–º json —Å –ú–ö–î —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ IP-–∞–¥—Ä–µ—Å–∞–º–∏: cp /home/protei/Protei-MKD/MKD/profiles/registrations.db /home/support/data_for_api/reg_from_mkd.json 
5. –û–±–Ω–æ–≤–∏—Ç—å IP –∞–¥—Ä–µ—Å–∞ –∞–±–æ–Ω–µ–Ω—Ç–æ–≤ (–º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–≥–æ –Ω–µ—Ç –≤ –ë–î) –Ω–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Å –ú–ö–î: python3 json_update.py{jh}

–°–∫—Ä–∏–ø—Ç –ø–æ —Ä–∞–±–æ—Ç–µ —Å –¥–∞–Ω–Ω—ã–º–∏:
1. chmod +x manage_data.sh  
2. ./manage_data.sh  
3. –í—ã–±–æ—Ä –¥–µ–π—Å—Ç–≤–∏–π:  
echo "1. üîß –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (–ø–µ—Ä–≤–∞—è –≤—ã–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö)"  
echo "2. ‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"  
echo "3. üåê –û–±–Ω–æ–≤–∏—Ç—å IP –∞–¥—Ä–µ—Å–∞"  
